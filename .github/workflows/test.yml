name: Test Action

on:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-action:
    name: Test .NET Setup
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Debug - Print environment variables
        run: env | sort

      - name: Setup .NET using this action
        uses: ./
        id: setup-dotnet
        with:
          #sdk-version: lts, 10.0.x
          aspnetcore-version: sts, 8.x.x
          runtime-version: latest
          cache: false

      - name: Verify .NET installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        run: |
          echo "Installed version: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Dotnet path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-global-json:
    name: Test global.json Support
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sample:
          - name: "Exact Version"
            file: "global.json.exact"
            expected-major: "10"
          - name: "Latest Patch"
            file: "global.json.patch"
            expected-major: "9"
          - name: "Latest Feature"
            file: "global.json.feature"
            expected-major: "8"
          - name: "Latest Minor"
            file: "global.json.minor"
            expected-major: "8"
          - name: "Preview Exact Version"
            file: "global.json.preview"
            expected-major: "9"
          - name: "Preview with Latest Major"
            file: "global.json.preview-latestmajor"
            expected-major: "10"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        run: |
          cp samples/${{ matrix.sample.file }} global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet

      - name: Verify SDK installation
        run: dotnet --list-sdks

  test-global-json-with-runtime:
    name: Test global.json Support with Runtime
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        run: |
          cp samples/global.json.feature global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet
        with:
          dotnet-aspnetcore: 10.x.x

      - name: Verify SDK & Runtime installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

  test-lts-sts-keywords:
    name: Test LTS/STS Keywords
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET with LTS/STS
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: lts, sts
          runtime-version: latest
          aspnetcore-version: sts, 8.0.0

      - name: Verify installation
        run: |
          echo "=== SDKs ==="
          dotnet --list-sdks
          echo ""
          echo "=== Runtimes ==="
          dotnet --list-runtimes

      - name: Check outputs
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"
          echo "Cache-Hit: ${{ steps.setup-dotnet.outputs.cache-hit }}"

  test-multi-os-basic:
    name: Test Multi-OS Basic Installation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        version-config:
          - name: "SDK Latest"
            sdk: "latest"
            runtime: ""
            aspnetcore: ""
          - name: "SDK LTS"
            sdk: "lts"
            runtime: ""
            aspnetcore: ""
          - name: "SDK STS"
            sdk: "sts"
            runtime: ""
            aspnetcore: ""
          - name: "Runtime Latest"
            sdk: ""
            runtime: "latest"
            aspnetcore: ""
          - name: "Runtime LTS"
            sdk: ""
            runtime: "lts"
            aspnetcore: ""
          - name: "Runtime STS"
            sdk: ""
            runtime: "sts"
            aspnetcore: ""
          - name: "ASP.NET Core Latest"
            sdk: ""
            runtime: ""
            aspnetcore: "latest"
          - name: "ASP.NET Core LTS"
            sdk: ""
            runtime: ""
            aspnetcore: "lts"
          - name: "ASP.NET Core STS"
            sdk: ""
            runtime: ""
            aspnetcore: "sts"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET - ${{ matrix.version-config.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.version-config.sdk }}
          runtime-version: ${{ matrix.version-config.runtime }}
          aspnetcore-version: ${{ matrix.version-config.aspnetcore }}
          cache: false

      - name: Verify .NET installation
        run: |
          dotnet --version
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-global-json-prerelease:
    name: Test global.json with Prerelease
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        sample:
          - name: "Preview with allowPrerelease"
            file: "global.json.preview"
          - name: "Preview with Latest Major"
            file: "global.json.preview-latestmajor"
          - name: "With Comments"
            file: "global.json.with-comments"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        shell: bash
        run: |
          cp samples/${{ matrix.sample.file }} global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet
        with:
          cache: false

      - name: Verify SDK installation
        run: |
          dotnet --version
          dotnet --list-sdks

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-caching:
    name: Test Caching Enabled
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET with caching enabled
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: "10.x"
          runtime-version: "9.x"
          aspnetcore-version: "9.x"
          cache: true

      - name: Verify installation
        run: |
          dotnet --version
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"
          echo "Cache-Hit: ${{ steps.setup-dotnet.outputs.cache-hit }}"

  test-version-combinations:
    name: Test Version Combinations
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        scenario:
          - name: "Multiple SDKs"
            sdk: "10.x.x, 9.0.100"
            runtime: ""
            aspnetcore: ""
          - name: "SDK + Multiple Runtimes"
            sdk: "latest"
            runtime: "9.0.0, 8.0.0, 7.0.0"
            aspnetcore: ""
          - name: "All Components Mixed"
            sdk: "lts, sts"
            runtime: "latest"
            aspnetcore: "9.x.x, 8.0.0"
          - name: "Wildcards Mix"
            sdk: "10.x, 9.x.x"
            runtime: "9.x, 8.x"
            aspnetcore: "9.x"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Verify installation
        run: |
          echo "=== Installed .NET Version ==="
          dotnet --version
          echo ""
          echo "=== All SDKs ==="
          dotnet --list-sdks
          echo ""
          echo "=== All Runtimes ==="
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-global-json-override:
    name: Test global.json Override
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        scenario:
          - name: "Input SDK overrides global.json"
            global-json-file: "global.json.exact"
            sdk: "9.x"
            runtime: ""
            aspnetcore: ""
          - name: "Input SDK + Runtime with global.json"
            global-json-file: "global.json.feature"
            sdk: "10.x"
            runtime: "9.0.0"
            aspnetcore: ""
          - name: "Input SDK + ASP.NET Core with global.json"
            global-json-file: "global.json.patch"
            sdk: "lts"
            runtime: ""
            aspnetcore: "9.x"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        shell: bash
        run: |
          cp samples/${{ matrix.scenario.global-json-file }} global.json
          echo "=== global.json content ==="
          cat global.json

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Verify installation
        run: |
          dotnet --version
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-yaml-array-inputs:
    name: Test YAML Array Inputs
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET with YAML array syntax
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: |
            10.x.x
            9.0.100
          runtime-version: |
            9.0.0
            8.0.0
          aspnetcore-version: |
            9.x
            8.0.0
          cache: false

      - name: Verify installation
        run: |
          echo "=== Installed .NET Version ==="
          dotnet --version
          echo ""
          echo "=== All SDKs ==="
          dotnet --list-sdks
          echo ""
          echo "=== All Runtimes ==="
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-edge-cases:
    name: Test Edge Cases
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: "Only cache with global.json"
            global-json-file: "global.json.exact"
            sdk: ""
            runtime: ""
            aspnetcore: ""
            cache: "true"
          - name: "Duplicate versions in input"
            global-json-file: ""
            sdk: "10.x, 10.x.x, latest"
            runtime: ""
            aspnetcore: ""
            cache: "false"
          - name: "Mixed keywords and versions"
            global-json-file: ""
            sdk: "lts, 9.0.100, sts"
            runtime: "latest, 8.0.0"
            aspnetcore: "9.x, sts"
            cache: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup global.json if needed
        if: matrix.scenario.global-json-file != ''
        run: |
          cp samples/${{ matrix.scenario.global-json-file }} global.json
          echo "=== global.json content ==="
          cat global.json

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: ${{ matrix.scenario.cache }}

      - name: Verify installation
        run: |
          dotnet --version
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"
          echo "Cache-Hit: ${{ steps.setup-dotnet.outputs.cache-hit }}"

  test-performance:
    name: Test Performance & Parallel Downloads
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET with many versions
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: "10.x, 9.x, 8.x"
          runtime-version: "9.0.0, 8.0.0, 7.0.0"
          aspnetcore-version: "9.0.0, 8.0.0"
          cache: false

      - name: Verify all installations
        run: |
          echo "=== Installed .NET Version ==="
          dotnet --version
          echo ""
          echo "=== All SDKs ==="
          dotnet --list-sdks
          echo ""
          echo "=== All Runtimes ==="
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

      - name: Test functionality
        shell: bash
        run: |
          dotnet new console -n TestApp
          cd TestApp
          dotnet run
