name: Test Action

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-action:
    name: Test .NET Setup
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Debug - Print environment variables
        run: env | sort

      - name: Setup .NET using this action
        uses: ./
        id: setup-dotnet
        with:
          #sdk-version: lts, 10.0.x
          aspnetcore-version: sts, 8.x.x
          runtime-version: latest
          cache: false

      - name: Verify .NET installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        run: |
          echo "Installed version: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Dotnet path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"

  test-global-json:
    name: Test global.json Support
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sample:
          - name: "Exact Version"
            file: "global.json.exact"
            expected-major: "10"
          - name: "Latest Patch"
            file: "global.json.patch"
            expected-major: "9"
          - name: "Latest Feature"
            file: "global.json.feature"
            expected-major: "8"
          - name: "Latest Minor"
            file: "global.json.minor"
            expected-major: "8"
          - name: "Preview Exact Version"
            file: "global.json.preview"
            expected-major: "9"
          - name: "Preview with Latest Major"
            file: "global.json.preview-latestmajor"
            expected-major: "10"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        run: |
          cp samples/${{ matrix.sample.file }} global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet

      - name: Verify SDK installation
        run: dotnet --list-sdks

  test-global-json-with-runtime:
    name: Test global.json Support with Runtime
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup test environment with global.json
        run: |
          cp samples/global.json.feature global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet
        with:
          dotnet-aspnetcore: 10.x.x

      - name: Verify SDK & Runtime installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

  test-lts-sts-keywords:
    name: Test LTS/STS Keywords
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup .NET with LTS/STS
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: lts, sts
          runtime-version: latest
          aspnetcore-version: sts, 8.0.0

      - name: Verify installation
        run: |
          echo "=== SDKs ==="
          dotnet --list-sdks
          echo ""
          echo "=== Runtimes ==="
          dotnet --list-runtimes

      - name: Check outputs
        run: |
          echo "Installed: ${{ steps.setup-dotnet.outputs.dotnet-version }}"
          echo "Path: ${{ steps.setup-dotnet.outputs.dotnet-path }}"
          echo "Cache-Hit: ${{ steps.setup-dotnet.outputs.cache-hit }}" 
