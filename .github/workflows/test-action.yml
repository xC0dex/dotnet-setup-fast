name: Test Action

on:
  pull_request:
    paths:
      - '.github/workflows/test-action.yml'
      - 'src/**'
      - 'dist/index.js'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-global-json:
    name: Test global.json Support
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sample:
          - name: 'Exact Version'
            file: 'global.json.exact'
            expected-major: '10'
          - name: 'Latest Patch'
            file: 'global.json.patch'
            expected-major: '9'
          - name: 'Latest Feature'
            file: 'global.json.feature'
            expected-major: '8'
          - name: 'Latest Minor'
            file: 'global.json.minor'
            expected-major: '8'
          - name: 'Preview Exact Version'
            file: 'global.json.preview'
            expected-major: '9'
          - name: 'Preview with Latest Major'
            file: 'global.json.preview-latestmajor'
            expected-major: '10'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup test environment with global.json
        run: |
          cp samples/${{ matrix.sample.file }} global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet
        with:
          cache: false

      - name: Verify SDK installation
        run: dotnet --list-sdks

  test-lts-sts-keywords:
    name: Test LTS/STS Keywords
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup .NET with LTS/STS
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: lts, sts
          runtime-version: latest
          aspnetcore-version: sts, 8.0.0
          cache: false

      - name: Verify installation
        shell: bash
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

  test-global-json-prerelease:
    name: Test global.json with Prerelease
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sample:
          - name: 'Preview with allowPrerelease'
            file: 'global.json.preview'
          - name: 'Preview with Latest Major'
            file: 'global.json.preview-latestmajor'
          - name: 'With Comments'
            file: 'global.json.with-comments'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup test environment with global.json
        shell: bash
        run: |
          cp samples/${{ matrix.sample.file }} global.json
          cat global.json

      - name: Setup .NET from global.json
        uses: ./
        id: setup-dotnet
        with:
          cache: false

      - name: Verify SDK installation
        run: |
          dotnet --list-sdks

  test-caching:
    name: Test Caching Enabled
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          [
            ubuntu-latest,
            ubuntu-slim,
            windows-latest,
            macos-latest,
            self-hosted,
          ]

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: print environment variables
        run: printenv | sort

      - name: Setup .NET with caching enabled
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: '10.x'
          runtime-version: '9.x, 6.0.0'
          aspnetcore-version: '9.0.0'

      - name: Verify installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Setup .NET with caching enabled (second run)
        uses: ./
        with:
          sdk-version: '10.x'
          runtime-version: '9.x, 6.0.0'
          aspnetcore-version: '9.0.0'

      - name: Verify installation (second run)
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Check outputs
        shell: bash
        run: |
          echo "Cache-Hit: ${{ steps.setup-dotnet.outputs.cache-hit }}"

  test-version-combinations:
    name: Test Version Combinations
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          [
            ubuntu-latest,
            ubuntu-slim,
            windows-latest,
            macos-latest,
            self-hosted,
          ]
        scenario:
          - name: 'Multiple SDKs'
            sdk: '10.x.x, 9.0.100'
            runtime: ''
            aspnetcore: ''
          - name: 'SDK + Multiple Runtimes'
            sdk: 'latest'
            runtime: '9.0.0, 8.0.0, 7.0.0'
            aspnetcore: ''
          - name: 'All Components Mixed'
            sdk: 'lts, sts'
            runtime: 'latest'
            aspnetcore: '9.x.x, 8.0.0'
          - name: 'Wildcards Mix'
            sdk: '10.x, 9.x.x'
            runtime: '9.x, 8.x'
            aspnetcore: '9.x'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Verify installation
        run: |
          dotnet --info
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Install tools
        run: |
          dotnet tool install --global dotnet-ef
          dotnet tool list --global

      - name: Verify tool installation
        run: dotnet-ef --version

  test-global-json-override:
    name: Test global.json Override
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: 'Input SDK overrides global.json'
            global-json-file: 'global.json.exact'
            sdk: '9.x'
            runtime: ''
            aspnetcore: ''
          - name: 'Input SDK + Runtime with global.json'
            global-json-file: 'global.json.feature'
            sdk: '10.x'
            runtime: '9.0.0'
            aspnetcore: ''
          - name: 'Input SDK + ASP.NET Core with global.json'
            global-json-file: 'global.json.patch'
            sdk: 'lts'
            runtime: ''
            aspnetcore: '9.x'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup test environment with global.json
        shell: bash
        run: |
          cp samples/${{ matrix.scenario.global-json-file }} global.json
          echo "=== global.json content ==="
          cat global.json

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Verify installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

  test-edge-cases:
    name: Test Edge Cases
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: 'Duplicate versions in input'
            global-json-file: ''
            sdk: '10.x, 10.x.x, latest'
            runtime: ''
            aspnetcore: ''
          - name: 'Mixed keywords and versions'
            global-json-file: ''
            sdk: 'lts, 9.0.100, sts'
            runtime: 'latest, 8.0.0'
            aspnetcore: '9.x, sts'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup global.json if needed
        if: matrix.scenario.global-json-file != ''
        run: |
          cp samples/${{ matrix.scenario.global-json-file }} global.json
          echo "=== global.json content ==="
          cat global.json

      - name: Setup .NET - ${{ matrix.scenario.name }}
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Verify installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

      - name: Setup .NET - ${{ matrix.scenario.name }} (second run)
        uses: ./
        with:
          sdk-version: ${{ matrix.scenario.sdk }}
          runtime-version: ${{ matrix.scenario.runtime }}
          aspnetcore-version: ${{ matrix.scenario.aspnetcore }}
          cache: false

      - name: Setup .NET - ${{ matrix.scenario.name }} (third run)
        uses: ./
        with:
          aspnetcore-version: '6.0.0'
          cache: false

      - name: Verify installation (third run)
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes

  test-latest-preview:
    name: Test Preview Versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup .NET with preview versions
        uses: ./
        id: setup-dotnet
        with:
          sdk-version: 'latest'
          allow-preview: true
          cache: false

      - name: Verify installation
        run: |
          dotnet --list-sdks
          dotnet --list-runtimes
